# ----------------------------------------------------------------------
# File: docker-compose.yml
# Author: iHub-2020
# Date: 2026-01-15
# Version: 1.3.0
# Description: Docker Compose configuration with Host Network mode
# Updated:
#   - Added JSON logging driver with size limits
#   - Improved environment variable documentation
#   - Enhanced healthcheck command
#   - Added SECRET_KEY generation instructions
#   - Clarified HOST_UID/HOST_GID usage
#   - Added security best practices
# GitHub: https://github.com/iHub-2020/docker-udp-tunnel
# ----------------------------------------------------------------------
version: '3.8'

services:
  udp-tunnel:
    # ================== é•œåƒé…ç½® ==================
    # ä½¿ç”¨ GitHub Container Registry é•œåƒ
    image: ghcr.io/ihub-2020/docker-udp-tunnel:latest
    
    # å¦‚æœéœ€è¦æœ¬åœ°æ„å»ºï¼Œæ³¨é‡Šä¸Šé¢çš„ imageï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Š
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    
    container_name: udp-tunnel-manager
    restart: unless-stopped
    
    # ================== ç½‘ç»œæ¨¡å¼ ==================
    # [å…³é”®] Host æ¨¡å¼
    # udp2raw éœ€è¦å¤„ç†åº•å±‚ç½‘ç»œåŒ…å’Œæ“ä½œ iptablesï¼ŒHost æ¨¡å¼æ€§èƒ½æœ€å¥½
    # å®¹å™¨å†…ç«¯å£ = å®¿ä¸»æœºç«¯å£ï¼ˆç«¯å£æ˜ å°„è¢«å¿½ç•¥ï¼‰
    # HTTP è®¿é—®ï¼šhttp://<å®¿ä¸»æœºIP>:5000
    # HTTPS è®¿é—®ï¼šhttps://<å®¿ä¸»æœºIP>:5000 (å¦‚æœ ENABLE_HTTPS=true)
    network_mode: host
    
    # ================== æƒé™é…ç½® ==================
    # [å…³é”®] NET_ADMIN æƒé™
    # å…è®¸å®¹å™¨æ“ä½œç½‘ç»œæ¥å£ã€iptables å’Œ raw socket
    cap_add:
      - NET_ADMIN
      
    # ================== å·æŒ‚è½½ ==================
    volumes:
      # é…ç½®æ–‡ä»¶æŒä¹…åŒ–ï¼ˆåŒ…å«éš§é“é…ç½®ï¼‰
      - ./config:/app/config
      
      # æ—¥å¿—æ–‡ä»¶æŒä¹…åŒ–
      - ./logs:/app/logs
      
      # [å¯é€‰] HTTPS è¯ä¹¦æŒ‚è½½ï¼ˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼‰
      # å¦‚æœä½¿ç”¨ Let's Encrypt æˆ–è‡ªæœ‰è¯ä¹¦ï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Š
      # - /etc/letsencrypt/live/your-domain:/app/config/certs:ro
      
    # ================== ç¯å¢ƒå˜é‡ ==================
    environment:
      # ------------------ Flask é…ç½® ------------------
      # è¿è¡Œç¯å¢ƒï¼ˆproduction/developmentï¼‰
      - FLASK_ENV=production
      
      # ------------------ è®¤è¯é…ç½® ------------------
      # Web ç•Œé¢ç™»å½•å¯†ç 
      # ğŸ”´ å®‰å…¨è­¦å‘Šï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ä¸ºå¼ºå¯†ç ï¼
      # å»ºè®®ï¼šè‡³å°‘ 16 ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
      - WEB_PASSWORD=your_secure_password_here
      
      # Flask Session å¯†é’¥ï¼ˆç”¨äºåŠ å¯†ä¼šè¯ Cookieï¼‰
      # ğŸ”´ å®‰å…¨è­¦å‘Šï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ä¸ºéšæœºå­—ç¬¦ä¸²ï¼
      # ç”Ÿæˆå‘½ä»¤ï¼špython3 -c "import secrets; print(secrets.token_hex(32))"
      # æˆ–ï¼šopenssl rand -hex 32
      - SECRET_KEY=your_secret_key_here
      
      # ------------------ HTTPS é…ç½® ------------------
      # HTTPS å¼€å…³ï¼ˆtrue/falseï¼‰
      # - true:  å¯ç”¨ HTTPSï¼ˆè‡ªåŠ¨ç”Ÿæˆè‡ªç­¾åè¯ä¹¦æˆ–ä½¿ç”¨æŒ‚è½½çš„è¯ä¹¦ï¼‰
      # - false: ä½¿ç”¨ HTTPï¼ˆé»˜è®¤ï¼Œé€‚åˆé…åˆ Nginx/Caddy åå‘ä»£ç†ï¼‰
      # 
      # è¯ä¹¦è·¯å¾„ï¼ˆå¦‚æœ ENABLE_HTTPS=trueï¼‰ï¼š
      #   - ./config/certs/server.crt (è¯ä¹¦)
      #   - ./config/certs/server.key (ç§é’¥)
      # å¦‚æœä¸å­˜åœ¨ï¼Œentrypoint.sh ä¼šè‡ªåŠ¨ç”Ÿæˆè‡ªç­¾åè¯ä¹¦
      - ENABLE_HTTPS=false
      
      # ------------------ æƒé™å¤„ç† ------------------
      # å®¿ä¸»æœºç”¨æˆ· UID å’Œ GIDï¼ˆç”¨äºæ—¥å¿—æ–‡ä»¶æƒé™æ˜ å°„ï¼‰
      # 
      # ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ
      #   å®¹å™¨å†…éƒ¨ä»¥ root è¿è¡Œï¼Œä½†æŒ‚è½½çš„æ—¥å¿—æ–‡ä»¶å±äºå®¿ä¸»æœºç”¨æˆ·
      #   è®¾ç½®è¿™äº›å˜é‡åï¼Œentrypoint.sh ä¼šè°ƒæ•´æ–‡ä»¶æƒé™
      # 
      # å¦‚ä½•è·å–ï¼Ÿ
      #   åœ¨å®¿ä¸»æœºæ‰§è¡Œï¼šid -u  (UID)
      #   åœ¨å®¿ä¸»æœºæ‰§è¡Œï¼šid -g  (GID)
      # 
      # ç¤ºä¾‹ï¼ˆå½“å‰é…ç½®ï¼‰ï¼š
      #   HOST_UID=1000, HOST_GID=1000 â†’ é€‚ç”¨äºå¤§å¤šæ•° Linux ç¬¬ä¸€ä¸ªç”¨æˆ·
      # 
      # å¦‚æœå®¿ä¸»æœºæ˜¯ root ç”¨æˆ·ï¼Œç•™ç©ºå³å¯ï¼š
      #   - HOST_UID=
      #   - HOST_GID=
      - HOST_UID=1000
      - HOST_GID=1000
      
    # ================== æ—¥å¿—é…ç½® ==================
    # é™åˆ¶ Docker å®¹å™¨æ—¥å¿—å¤§å°ï¼Œé˜²æ­¢ç£ç›˜å æ»¡
    # æ³¨æ„ï¼šè¿™æ˜¯ Docker æ—¥å¿—ï¼Œä¸æ˜¯åº”ç”¨å†…æ—¥å¿—ï¼ˆ/app/logs/udp-tunnel.logï¼‰
    logging:
      driver: "json-file"
      options:
        max-size: "10m"   # å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§ 10MB
        max-file: "3"     # ä¿ç•™æœ€è¿‘ 3 ä¸ªæ—¥å¿—æ–‡ä»¶
        
    # ================== å¥åº·æ£€æŸ¥ ==================
    # å®¹å™¨å¥åº·çŠ¶æ€æ£€æµ‹
    # æ³¨æ„ï¼šè™½ç„¶ä½¿ç”¨ host æ¨¡å¼ï¼Œä½†å®¹å™¨å†… 127.0.0.1 ä»æŒ‡å‘å®¹å™¨è‡ªèº«
    healthcheck:
      # ä¼˜åŒ–åçš„æ£€æµ‹å‘½ä»¤ï¼šå…ˆå°è¯• HTTPï¼Œå¤±è´¥åˆ™å°è¯• HTTPS
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:5000/health || curl -sfk https://127.0.0.1:5000/health || exit 1"]
      interval: 30s       # æ¯ 30 ç§’æ£€æµ‹ä¸€æ¬¡
      timeout: 10s        # å•æ¬¡æ£€æµ‹è¶…æ—¶æ—¶é—´
      retries: 3          # è¿ç»­å¤±è´¥ 3 æ¬¡æ ‡è®°ä¸º unhealthy
      start_period: 10s   # å®¹å™¨å¯åŠ¨å 10 ç§’å¼€å§‹æ£€æµ‹

# ================== è¡¥å……è¯´æ˜ ==================
# 
# ğŸ“Œ ç½‘ç»œè®¿é—®ï¼š
#   ç”±äºä½¿ç”¨ host æ¨¡å¼ï¼Œè®¿é—®åœ°å€ä¸ºï¼š
#   - HTTP:  http://<å®¿ä¸»æœºIP>:5000
#   - HTTPS: https://<å®¿ä¸»æœºIP>:5000 (å¦‚æœ ENABLE_HTTPS=true)
# 
# ğŸ“Œ é˜²ç«å¢™é…ç½®ï¼ˆå¦‚æœå®¿ä¸»æœºå¯ç”¨äº†é˜²ç«å¢™ï¼‰ï¼š
#   # UFW ç¤ºä¾‹
#   sudo ufw allow 5000/tcp
#   
#   # firewalld ç¤ºä¾‹
#   sudo firewall-cmd --permanent --add-port=5000/tcp
#   sudo firewall-cmd --reload
# 
# ğŸ“Œ ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼š
#   1. ä¿®æ”¹ WEB_PASSWORD ä¸ºå¼ºå¯†ç 
#   2. ç”Ÿæˆéšæœº SECRET_KEYï¼š
#      python3 -c "import secrets; print(secrets.token_hex(32))"
#   3. ä½¿ç”¨åå‘ä»£ç†å¤„ç† HTTPSï¼ˆNginx/Caddyï¼‰ï¼Œä¿æŒ ENABLE_HTTPS=false
#   4. å®šæœŸå¤‡ä»½ ./config ç›®å½•
#   5. ç›‘æ§ ./logs ç›®å½•å¤§å°
# 
# ğŸ“Œ æŸ¥çœ‹æ—¥å¿—ï¼š
#   # Docker å®¹å™¨æ—¥å¿—
#   docker logs -f udp-tunnel-manager
#   
#   # åº”ç”¨æ—¥å¿—
#   tail -f ./logs/udp-tunnel.log
#   tail -f ./logs/udp2raw.log
# 
# ğŸ“Œ æ›´æ–°é•œåƒï¼š
#   docker-compose pull
#   docker-compose up -d
