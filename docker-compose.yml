# ----------------------------------------------------------------------
# File: docker-compose.yml
# Author: iHub-2020
# Date: 2026-01-13
# Version: 1.1.0 (æ”¯æŒ HTTP/HTTPS åˆ‡æ¢)
# ----------------------------------------------------------------------
version: '3.8'

services:
  udp-tunnel:
    image: udp-tunnel:latest

    container_name: udp-tunnel-web
    restart: always
    network_mode: host
    
    cap_add:
      - NET_ADMIN
      
    volumes:
      - /opt/udp-tunnel/config:/app/config
      - /opt/udp-tunnel/logs:/app/logs
      # [å¯é€‰] è¯ä¹¦ç›®å½•
      # å¦‚æœå¯ç”¨ HTTPS (ENABLE_HTTPS=true)ï¼Œè¯·å–æ¶ˆä¸‹æ–¹æ³¨é‡Šå¹¶ç¡®ä¿è¯ä¹¦å­˜åœ¨
      # - ./certs:/app/certs
      
    environment:
      - FLASK_ENV=production
      # ğŸ‘‡ã€å…³é”®ä¿®æ”¹ã€‘åŠ ä¸Šè¿™ä¸€è¡Œï¼Œå¼ºåˆ¶ Python æŠŠ /app/app åŠ å…¥æœç´¢è·¯å¾„
      - PYTHONPATH=/app/app
      # [æ ¸å¿ƒé…ç½®] æ§åˆ¶æ˜¯å¦å¼€å¯ HTTPS
      # false = ä½¿ç”¨ HTTP (é»˜è®¤ï¼Œæ— éœ€è¯ä¹¦)
      # true  = ä½¿ç”¨ HTTPS (éœ€è¦æŒ‚è½½è¯ä¹¦ç›®å½•)
      - ENABLE_HTTPS=false
      
    # [å¥åº·æ£€æŸ¥é‡å†™]
    # docker-compose çš„é…ç½®ä¼šè¦†ç›– Dockerfile ä¸­çš„ HEALTHCHECK
    healthcheck:
      # è¿™é‡Œä½¿ç”¨é€»è¾‘åˆ¤æ–­ï¼š
      # å¦‚æœæ˜¯ HTTP æ¨¡å¼ï¼Œcurl http://...
      # å¦‚æœæ˜¯ HTTPS æ¨¡å¼ï¼Œcurl -k https://...
      # æ³¨æ„ï¼šä¸ºäº†å…¼å®¹æ€§ï¼Œå»ºè®®æ ¹æ®ä½ å®é™…é€‰æ‹©çš„æ¨¡å¼ä¿®æ”¹ä¸‹é¢çš„ test å‘½ä»¤
      
      # --- æ–¹æ¡ˆ A: å½“å‰ä½¿ç”¨ HTTP æ¨¡å¼ (æ— è¯ä¹¦) ---
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:5000/health || exit 1"]
      
      # --- æ–¹æ¡ˆ B: å¦‚æœä½ å¼€å¯äº† HTTPSï¼Œè¯·ä½¿ç”¨ä¸‹é¢è¿™è¡Œä»£æ›¿ä¸Šé¢é‚£è¡Œ ---
      # test: ["CMD-SHELL", "curl -k -f https://127.0.0.1:5000/health || exit 1"]
      
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
