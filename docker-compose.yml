# ----------------------------------------------------------------------
# File: docker-compose.yml
# Author: iHub-2020
# Date: 2026-01-13
# Version: 1.1.0 (支持 HTTP/HTTPS 切换)
# ----------------------------------------------------------------------
version: '3.8'

services:
  udp-tunnel:
    build: .
    image: udp-tunnel:latest
    container_name: udp-tunnel-web
    restart: always
    network_mode: host
    
    cap_add:
      - NET_ADMIN
      
    volumes:
      - ./config:/app/config
      - ./logs:/app/logs
      # [可选] 证书目录
      # 如果启用 HTTPS (ENABLE_HTTPS=true)，请取消下方注释并确保证书存在
      # - ./certs:/app/certs
      
    environment:
      - FLASK_ENV=production
      # [核心配置] 控制是否开启 HTTPS
      # false = 使用 HTTP (默认，无需证书)
      # true  = 使用 HTTPS (需要挂载证书目录)
      - ENABLE_HTTPS=false
      
    # [健康检查重写]
    # docker-compose 的配置会覆盖 Dockerfile 中的 HEALTHCHECK
    healthcheck:
      # 这里使用逻辑判断：
      # 如果是 HTTP 模式，curl http://...
      # 如果是 HTTPS 模式，curl -k https://...
      # 注意：为了兼容性，建议根据你实际选择的模式修改下面的 test 命令
      
      # --- 方案 A: 当前使用 HTTP 模式 (无证书) ---
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:5000/health || exit 1"]
      
      # --- 方案 B: 如果你开启了 HTTPS，请使用下面这行代替上面那行 ---
      # test: ["CMD-SHELL", "curl -k -f https://127.0.0.1:5000/health || exit 1"]
      
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
