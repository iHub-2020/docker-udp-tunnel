# ----------------------------------------------------------------------
# File: docker-compose.yml
# Author: iHub-2020
# Date: 2026-01-13
# Version: 1.2.0
# Description: Docker Compose configuration with Host Network mode
# Updated: Added HOST_UID/HOST_GID environment variables for permission handling
# ----------------------------------------------------------------------
version: '3.8'

services:
  udp-tunnel:
    # ä½¿ç”¨ GitHub Container Registry é•œåƒ
    image: ghcr.io/ihub-2020/docker-udp-tunnel:latest
    container_name: udp-tunnel-manager
    restart: unless-stopped
    
    # [å…³é”®] Host æ¨¡å¼
    # udp2raw éœ€è¦å¤„ç†åº•å±‚ç½‘ç»œåŒ…ï¼ŒHost æ¨¡å¼æ€§èƒ½æœ€å¥½ä¸”é…ç½®æœ€ç®€å•
    # å¦‚æœä¸ä½¿ç”¨ host æ¨¡å¼ï¼Œéœ€è¦æå…¶å¤æ‚çš„ iptables æ˜ å°„
    network_mode: host
    
    # [å…³é”®] æƒé™
    # å…è®¸å®¹å™¨æ“ä½œç½‘ç»œæ¥å£å’Œ iptables
    cap_add:
      - NET_ADMIN
      
    volumes:
      - ./config:/app/config
      - ./logs:/app/logs
      # - /path/to/your/certs:/app/config/certs:ro  # åªè¯»æŒ‚è½½è¯ä¹¦
      
    environment:
      - FLASK_ENV=production
      - WEB_PASSWORD=your_secure_password_here  # ğŸŸ¢ Set your password
      - SECRET_KEY=your_secret_key_here  # ğŸŸ¢ Flask session secret
      # [HTTPS å¼€å…³]
      # true:  å¼€å¯ HTTPS (è‡ªåŠ¨ç”Ÿæˆè‡ªç­¾åè¯ä¹¦æˆ–ä½¿ç”¨æŒ‚è½½è¯ä¹¦)
      # false: å¼€å¯ HTTP (é»˜è®¤ï¼Œé€‚åˆé…åˆ Nginx åä»£ä½¿ç”¨)
      - ENABLE_HTTPS=false
      # [æƒé™å¤„ç†]
      # ä¼ é€’å®¿ä¸»æœºç”¨æˆ·IDï¼Œç”¨äºæ—¥å¿—æ–‡ä»¶æƒé™å¤„ç†
      - HOST_UID=1000
      - HOST_GID=1000
      
    # [å¥åº·æ£€æŸ¥]
    # æ³¨æ„ï¼šç”±äºä½¿ç”¨äº† host æ¨¡å¼ï¼Œlocalhost æŒ‡å‘çš„æ˜¯å®¿ä¸»æœº
    # ä½†åœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œ healthcheck å‘½ä»¤æ—¶ï¼Œlocalhost ä¾ç„¶æ˜¯æŒ‡å‘å®¹å™¨è‡ªèº«
    healthcheck:
      # ä½¿ç”¨ curl çš„ -k å‚æ•°å¿½ç•¥è¯ä¹¦é”™è¯¯ï¼ŒåŒæ—¶æ”¯æŒ HTTP å’Œ HTTPS
      test: ["CMD-SHELL", "curl -k -f http://127.0.0.1:5000/health || curl -k -f https://127.0.0.1:5000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

      start_period: 10s

