<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UDP Tunnel Manager</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- È¢ÑÁïô CSS Á±ªËØ¥ÊòéÔºö
         Êú¨ HTML ÁªìÊûÑ‰æùËµñ style.css Êèê‰æõÊ†∑Âºè„ÄÇ
         ‰ΩøÁî®‰∫ÜÁ±ª‰ºº Tailwind/Bootstrap ÁöÑÁ±ªÂêç (btn, card, status-badge Á≠â) 
         ‰ª•ÈÖçÂêà app.js ‰∏≠ÁöÑ classList Êìç‰Ωú„ÄÇ
    -->
</head>
<body data-theme="dark">

    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
    <nav class="navbar">
        <div class="navbar-brand">
            <span class="icon">üõ°Ô∏è</span>
            <h1>UDP Tunnel Manager</h1>
            <span class="subtitle" data-i18n="app_subtitle">A web UI based on udp2raw</span>
        </div>
        <div class="navbar-actions">
            <div class="lang-switch">
                <button class="btn btn-sm" onclick="setLanguage('zh')">‰∏≠Êñá</button>
                <button class="btn btn-sm" onclick="setLanguage('en')">English</button>
            </div>
            <!-- ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆÔºöID ÂØπÂ∫î app.js toggleTheme() -->
            <button class="btn btn-icon" onclick="toggleTheme()" title="Toggle Theme">
                <!-- Â§™Èò≥ÂõæÊ†á (Light Mode) -->
                <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <!-- Êúà‰∫ÆÂõæÊ†á (Dark Mode) -->
                <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: block;">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
            <a href="https://github.com/iHub-2020/docker-udp-tunnel" target="_blank" class="btn btn-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C3.62.65 2.42 1 2.42 1a5.07 5.07 0 0 0-.58 3.77A5.44 5.44 0 0 0 2.42 9c0 5.15 3.31 6.66 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
            </a>
        </div>
    </nav>

    <div class="container">
        <!-- Áä∂ÊÄÅÊ†è -->
        <div class="status-bar card">
            <div class="status-left">
                <span data-i18n="service_status">Service Status:</span>
                <!-- app.js ‰ºöÊìç‰ΩúËøô‰∏™ badge ÁöÑ class Âíå text -->
                <span id="status-badge" class="status-badge stopped" data-i18n="stopped">Stopped</span>
                <span id="tunnel-count" class="text-muted">(0 tunnels active)</span>
            </div>
            <div class="status-right">
                <button class="btn btn-primary" onclick="openDiagnostics()">
                    <span class="icon">ü©∫</span> <span data-i18n="diagnostics">Diagnostics</span>
                </button>
            </div>
        </div>

        <!-- Ë≠¶Âëä‰ø°ÊÅØ -->
        <div class="alert alert-warning">
            <h4 data-i18n="safety_info_title">‚ö†Ô∏è Critical Safety Information</h4>
            <ul>
                <li data-i18n="safety_info_1">FakeTCP mode REQUIRES iptables rules to block kernel TCP RST packets.</li>
                <li data-i18n="safety_info_2">On OpenWrt, iptables rules may be cleared when network settings change.</li>
                <li data-i18n="safety_info_3">The "Keep Iptables Rules" option is STRONGLY recommended for OpenWrt.</li>
                <li data-i18n="safety_info_4">Server Mode: You MUST specify "Forward To" address (usually 127.0.0.1).</li>
            </ul>
        </div>

        <!-- ÂÖ®Â±ÄËÆæÁΩÆ -->
        <div class="card">
            <div class="card-header">
                <h3 data-i18n="global_settings">Global Settings</h3>
                <p class="text-muted" data-i18n="global_settings_desc">Global settings for udp2raw daemon.</p>
            </div>
            <div class="card-body form-grid">
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="cfg-enabled">
                        <span data-i18n="enable_service">Enable Service</span>
                    </label>
                    <small data-i18n="enable_service_desc">Master switch. If disabled, no tunnels will run.</small>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="cfg-keep-iptables">
                        <span data-i18n="keep_iptables">Keep Iptables Rules</span>
                    </label>
                    <small data-i18n="keep_iptables_desc">Auto-restore iptables rules if cleared by system.</small>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="cfg-wait-lock">
                        <span data-i18n="wait_lock">Wait for Iptables Lock</span>
                    </label>
                    <small data-i18n="wait_lock_desc">Wait for xtables lock while invoking iptables.</small>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="cfg-retry-on-error">
                        <span data-i18n="retry_on_error">Retry on Error</span>
                    </label>
                    <small data-i18n="retry_on_error_desc">Allow starting even if network is not ready.</small>
                </div>
                <div class="form-group">
                    <label data-i18n="log_level">Log Level</label>
                    <select id="cfg-log-level" class="form-control">
                        <option value="info">Info (Default)</option>
                        <option value="fatal">Fatal</option>
                        <option value="error">Error</option>
                        <option value="warn">Warning</option>
                        <option value="debug">Debug</option>
                        <option value="trace">Trace</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ÊúçÂä°Á´ØÂÆû‰æã (-s) -->
        <div class="card">
            <div class="card-header with-tabs">
                <div>
                    <h3 data-i18n="server_instances">Server Instances (-s)</h3>
                    <p class="text-muted" data-i18n="server_mode_desc">Server Mode: OpenWrt listens for connections.</p>
                </div>
                <!-- Tabs: ÂØπÂ∫î app.js switchSubTab('server', ...) -->
                <div class="tabs">
                    <button class="tab-btn active" data-tab="server-config" onclick="switchSubTab('server', 'config')" data-i18n="config">Config</button>
                    <button class="tab-btn" data-tab="server-status" onclick="switchSubTab('server', 'status')" data-i18n="status">Status</button>
                </div>
            </div>
            
            <!-- Server Config Content -->
            <div id="server-config-content" class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th data-i18n="name">Name</th>
                            <th data-i18n="enable">Enable</th>
                            <th data-i18n="listen_port">Listen Port</th>
                            <th data-i18n="forward_ip">Forward IP</th>
                            <th data-i18n="forward_port">Forward Port</th>
                            <th data-i18n="actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="server-table-body">
                        <!-- Áî± app.js renderServerTable() Â°´ÂÖÖ -->
                    </tbody>
                </table>
                <button class="btn btn-primary mt-2" onclick="openAddModal('server')">
                    <span class="icon">+</span> <span data-i18n="add_server">Add Server</span>
                </button>
            </div>

            <!-- Server Status Content -->
            <div id="server-status-content" class="card-body" style="display: none;">
                <table class="table">
                    <thead>
                        <tr>
                            <th data-i18n="name">Name</th>
                            <th data-i18n="status">Status</th>
                            <th data-i18n="local">Local</th>
                            <th data-i18n="forward">Forward</th>
                            <th data-i18n="protocol">Protocol</th>
                            <th data-i18n="pid">PID</th>
                        </tr>
                    </thead>
                    <tbody id="server-status-table-body">
                        <!-- Áî± app.js updateStatusTables() Â°´ÂÖÖ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ÂÆ¢Êà∑Á´ØÂÆû‰æã (-c) -->
        <div class="card">
            <div class="card-header with-tabs">
                <div>
                    <h3 data-i18n="client_instances">Client Instances (-c)</h3>
                    <p class="text-muted" data-i18n="client_mode_desc">Client Mode: OpenWrt connects to remote server.</p>
                </div>
                <!-- Tabs: ÂØπÂ∫î app.js switchSubTab('client', ...) -->
                <div class="tabs">
                    <button class="tab-btn active" data-tab="client-config" onclick="switchSubTab('client', 'config')" data-i18n="config">Config</button>
                    <button class="tab-btn" data-tab="client-status" onclick="switchSubTab('client', 'status')" data-i18n="status">Status</button>
                </div>
            </div>

            <!-- Client Config Content -->
            <div id="client-config-content" class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th data-i18n="name">Name</th>
                            <th data-i18n="enable">Enable</th>
                            <th data-i18n="server_ip">Server IP</th>
                            <th data-i18n="server_port">Server Port</th>
                            <th data-i18n="local_port">Local Port</th>
                            <th data-i18n="actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="client-table-body">
                        <!-- Áî± app.js renderClientTable() Â°´ÂÖÖ -->
                    </tbody>
                </table>
                <button class="btn btn-primary mt-2" onclick="openAddModal('client')">
                    <span class="icon">+</span> <span data-i18n="add_client">Add Client</span>
                </button>
            </div>

            <!-- Client Status Content -->
            <div id="client-status-content" class="card-body" style="display: none;">
                <table class="table">
                    <thead>
                        <tr>
                            <th data-i18n="name">Name</th>
                            <th data-i18n="status">Status</th>
                            <th data-i18n="local">Local</th>
                            <th data-i18n="remote">Remote</th>
                            <th data-i18n="protocol">Protocol</th>
                            <th data-i18n="pid">PID</th>
                        </tr>
                    </thead>
                    <tbody id="client-status-table-body">
                        <!-- Áî± app.js updateStatusTables() Â°´ÂÖÖ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Â∫ïÈÉ®Êìç‰ΩúÊåâÈíÆ -->
        <div class="action-bar">
            <button class="btn btn-primary btn-lg" onclick="saveConfig()" data-i18n="save_apply">Save & Apply</button>
            <button class="btn btn-secondary btn-lg" onclick="saveConfigOnly()" data-i18n="save_only">Save Only</button>
            <button class="btn btn-danger btn-lg" onclick="resetConfig()" data-i18n="reset">Reset</button>
        </div>
    </div>

    <!-- ÈÖçÁΩÆÊ®°ÊÄÅÊ°Ü (Add/Edit) -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">New Instance</h3>
                <button class="btn-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="basic" onclick="switchModalTab('basic')" data-i18n="basic_settings">Basic Settings</button>
                <button class="modal-tab" data-tab="advanced" onclick="switchModalTab('advanced')" data-i18n="advanced_settings">Advanced Settings</button>
            </div>
            <div class="modal-body">
                <!-- Basic Settings Tab -->
                <div id="modal-basic">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="modal-enabled">
                            <span data-i18n="enable">Enable</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label data-i18n="alias">Alias</label>
                        <input type="text" id="modal-alias" class="form-control" placeholder="My Server">
                    </div>
                    
                    <!-- Server Specific Fields -->
                    <div id="server-fields" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label data-i18n="listen_ip">WAN Listen Address (-l)</label>
                                <input type="text" id="modal-listen-ip" class="form-control" value="0.0.0.0">
                            </div>
                            <div class="form-group">
                                <label data-i18n="listen_port">WAN Listen Port</label>
                                <input type="number" id="modal-listen-port" class="form-control" value="29900">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label data-i18n="forward_ip">Forward To IP</label>
                                <input type="text" id="modal-forward-ip" class="form-control" value="127.0.0.1">
                            </div>
                            <div class="form-group">
                                <label data-i18n="forward_port">Forward To Port</label>
                                <input type="number" id="modal-forward-port" class="form-control" value="51820">
                            </div>
                        </div>
                    </div>

                    <!-- Client Specific Fields -->
                    <div id="client-fields" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label data-i18n="server_ip">VPS Address</label>
                                <input type="text" id="modal-server-ip" class="form-control" placeholder="x.x.x.x">
                            </div>
                            <div class="form-group">
                                <label data-i18n="server_port">VPS Port</label>
                                <input type="number" id="modal-server-port" class="form-control" value="29900">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label data-i18n="local_ip">Local Listen Address</label>
                                <input type="text" id="modal-local-ip" class="form-control" value="127.0.0.1">
                            </div>
                            <div class="form-group">
                                <label data-i18n="local_port">Local Listen Port</label>
                                <input type="number" id="modal-local-port" class="form-control" value="3333">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label data-i18n="password">Password (-k)</label>
                        <div class="input-with-icon">
                            <input type="text" id="modal-password" class="form-control" placeholder="secret">
                            <span class="icon">üëÅ</span>
                        </div>
                    </div>
                </div>

                <!-- Advanced Settings Tab -->
                <div id="modal-advanced" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label data-i18n="raw_mode">Raw Mode</label>
                            <select id="modal-raw-mode" class="form-control">
                                <option value="faketcp">FakeTCP (Recommended)</option>
                                <option value="udp">UDP</option>
                                <option value="icmp">ICMP</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-i18n="cipher_mode">Cipher Mode</label>
                            <select id="modal-cipher-mode" class="form-control">
                                <option value="xor">XOR (Fast)</option>
                                <option value="aes128cbc">AES-128-CBC</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label data-i18n="auth_mode">Auth Mode</label>
                        <select id="modal-auth-mode" class="form-control">
                            <option value="simple">Simple (Basic)</option>
                            <option value="md5">MD5</option>
                            <option value="crc32">CRC32</option>
                            <option value="hmac_sha1">HMAC-SHA1</option>
                        </select>
                    </div>

                    <!-- Client Advanced Specifics -->
                    <div id="client-advanced-fields" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label data-i18n="source_ip">Source IP (--source-ip)</label>
                                <input type="text" id="modal-source-ip" class="form-control" placeholder="Optional">
                            </div>
                            <div class="form-group">
                                <label data-i18n="source_port">Source Port (--source-port)</label>
                                <input type="number" id="modal-source-port" class="form-control" placeholder="Optional">
                            </div>
                        </div>
                        <div class="form-group">
                            <label data-i18n="seq_mode">Sequence Mode</label>
                            <select id="modal-seq-mode" class="form-control">
                                <option value="0">0 - Disabled</option>
                                <option value="1">1 - Simple</option>
                                <option value="2">2 - Basic</option>
                                <option value="3">3 - Simulate real TCP (Recommended)</option>
                                <option value="4">4 - Full simulation</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="modal-auto-iptables" checked>
                            <span data-i18n="auto_iptables">Auto Add Iptables Rule (-a)</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label data-i18n="extra_args">Extra Arguments</label>
                        <input type="text" id="modal-extra-args" class="form-control" placeholder="e.g. --keep-rule">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()" data-i18n="close">Close</button>
                <button class="btn btn-primary" onclick="saveModal()" data-i18n="save">Save</button>
            </div>
        </div>
    </div>

    <!-- ËØäÊñ≠Ê®°ÊÄÅÊ°Ü (Diagnostics) -->
    <div id="diag-overlay" class="modal-overlay" style="display: none;">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 data-i18n="diagnostics_title">System Diagnostics</h3>
                <button class="btn-close" onclick="closeDiagnostics()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- ÈößÈÅìÁä∂ÊÄÅ -->
                <div class="diag-section">
                    <h4 data-i18n="tunnel_status">UDP Tunnel Status</h4>
                    <div id="diag-service-status" class="mb-2">
                        <!-- Áî± app.js Â°´ÂÖÖ -->
                    </div>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th data-i18n="name">Name</th>
                                <th data-i18n="mode">Mode</th>
                                <th data-i18n="status">Status</th>
                                <th data-i18n="local">Local</th>
                                <th data-i18n="remote">Remote</th>
                                <th data-i18n="protocol">Protocol</th>
                                <th data-i18n="pid">PID</th>
                            </tr>
                        </thead>
                        <tbody id="diag-tunnel-table">
                            <!-- Áî± app.js Â°´ÂÖÖ -->
                        </tbody>
                    </table>
                </div>

                <!-- Á≥ªÁªüÊ£ÄÊü• -->
                <div class="diag-section">
                    <h4 data-i18n="system_check">System Check</h4>
                    <div class="check-item">
                        <span class="label" data-i18n="core_binary">Core Binary:</span>
                        <!-- ËøôÈáåÁöÑ ID ÂøÖÈ°ªÂ≠òÂú®Ôºåapp.js ‰ºöÂÜôÂÖ•ÁúüÂÆûÁöÑ MD5 -->
                        <span id="diag-binary">Checking...</span>
                    </div>
                    <div class="check-item">
                        <span class="label" data-i18n="iptables_rules">Iptables Rules:</span>
                        <!-- ËøôÈáåÁöÑ ID ÂøÖÈ°ªÂ≠òÂú®Ôºåapp.js ‰ºöÂÜôÂÖ•ÁúüÂÆûÁöÑËßÑÂàôÈìæ -->
                        <span id="diag-iptables">Checking...</span>
                    </div>
                </div>

                <!-- Êó•Âøó -->
                <div class="diag-section">
                    <div class="flex-between">
                        <h4 data-i18n="recent_logs">Recent Logs</h4>
                        <span id="diag-log-time" class="text-muted text-sm"></span>
                    </div>
                    <div id="log-container" class="log-container">
                        <pre id="log-content">Loading logs...</pre>
                    </div>
                    <div class="log-actions mt-2">
                        <button class="btn btn-sm btn-outline" onclick="refreshLogs()" data-i18n="refresh_logs">Refresh Logs</button>
                        <button class="btn btn-sm btn-outline" onclick="scrollLogsToBottom()" data-i18n="scroll_bottom">Scroll to Bottom</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ËÑöÊú¨ÂºïÂÖ•ÔºöÈ°∫Â∫èÂæàÈáçË¶Å -->
    <script src="/static/js/i18n.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
