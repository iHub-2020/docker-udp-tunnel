<!--
 * File: app/templates/index.html
 * Author: iHub-2020
 * Date: 2026-01-14
 * Version: 2.7.0
 * Description: Main HTML template for UDP Tunnel Manager Web UI
 * Updated: Implemented i18n with data-i18n attributes
 * GitHub: https://github.com/iHub-2020/docker-udp-tunnel
 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UDP Tunnel Manager</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/static/js/i18n.js"></script>
</head>
<body data-theme="dark">
    <!-- Header -->
    <header class="top-header">
        <div class="header-center">
            <h1 class="header-title" data-i18n="app_title">UDP Tunnel Manager</h1>
            <span class="header-subtitle" data-i18n="app_subtitle">A web UI based on udp2raw</span>
        </div>
        <div class="header-actions">
            <!-- Language Dropdown -->
            <div class="icon-dropdown" id="lang-dropdown">
                <button class="icon-btn" onclick="toggleDropdown('lang-dropdown')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    <span class="dropdown-arrow">▾</span>
                </button>
                <div class="dropdown-menu">
                    <div class="dropdown-item" onclick="setLanguage('zh')">中文</div>
                    <div class="dropdown-item" onclick="setLanguage('en')">English</div>
                </div>
                <a href="https://github.com/iHub-2020/docker-udp-tunnel" target="_blank" class="icon-btn" title="View on GitHub">
                    <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
                    </svg>
                </a>
            </div>
            <!-- Theme Toggle -->
            <button class="icon-btn" onclick="toggleTheme()">
                <svg id="theme-icon-moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
                <svg id="theme-icon-sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
            </button>
        </div>
    </header>

    <main class="main-content">
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-info">
                <span data-i18n="service_status">Service Status</span>:
                <span id="status-badge" class="status-badge stopped" data-i18n="stopped">Stopped</span>
                <span id="tunnel-count" class="tunnel-count">(0)</span>
            </div>
            <button class="btn btn-outline btn-sm" id="btn-diagnostics" onclick="openDiagnostics()">
                <span data-i18n="diagnostics">Diagnostics</span>
            </button>
        </div>

        <!-- Safety Information -->
        <div class="safety-card">
            <h3 data-i18n="safety_title">Critical Safety Information</h3>
            <ul>
                <li data-i18n-html="safety_faketcp">FakeTCP mode <strong>REQUIRES</strong> iptables rules to block kernel TCP RST packets.</li>
                <li data-i18n-html="safety_openwrt">On OpenWrt, iptables rules may be <strong>cleared</strong> when network settings change.</li>
                <li data-i18n-html="safety_recommend">The "Keep Iptables Rules" option is <strong>STRONGLY</strong> recommended for OpenWrt.</li>
                <li data-i18n-html="safety_server">Server Mode: You <strong>MUST</strong> specify "Forward To" address (usually 127.0.0.1).</li>
            </ul>
        </div>

        <!-- Global Settings -->
        <section class="config-section">
            <h2 data-i18n="global_settings">Global Settings</h2>
            <p class="section-desc" data-i18n="global_settings_desc">Global settings for udp2raw daemon.</p>
            
            <div class="form-grid">
                <div class="form-row">
                    <label class="form-label">
                        <input type="checkbox" class="checkbox" id="cfg-enabled">
                        <span data-i18n="enable_service">Enable Service</span>
                    </label>
                    <span class="hint" data-i18n-title="enable_service_hint">ⓘ</span>
                </div>
                <div class="form-row">
                    <label class="form-label">
                        <input type="checkbox" class="checkbox" id="cfg-keep-iptables" checked>
                        <span data-i18n="keep_iptables">Keep Iptables Rules</span>
                    </label>
                    <span class="hint recommended">✓</span>
                </div>
                <div class="form-row">
                    <label class="form-label">
                        <input type="checkbox" class="checkbox" id="cfg-wait-lock" checked>
                        <span data-i18n="wait_iptables">Wait for Iptables Lock</span>
                    </label>
                    <span class="hint" data-i18n-title="wait_iptables_hint">ⓘ</span>
                </div>
                <div class="form-row">
                    <label class="form-label">
                        <input type="checkbox" class="checkbox" id="cfg-retry-on-error" checked>
                        <span data-i18n="retry_on_error">Retry on Error</span>
                    </label>
                    <span class="hint" data-i18n-title="retry_on_error_hint">ⓘ</span>
                </div>
                <div class="form-row">
                    <label class="form-label" data-i18n="log_level">Log Level</label>
                    <select id="cfg-log-level" class="form-select">
                        <option value="info" data-i18n="log_info">Info (Default)</option>
                        <option value="fatal" data-i18n="log_fatal">Fatal</option>
                        <option value="error" data-i18n="log_error">Error</option>
                        <option value="warning" data-i18n="log_warning">Warning</option>
                        <option value="debug" data-i18n="log_debug">Debug</option>
                        <option value="trace" data-i18n="log_trace">Trace</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Server Instances -->
        <section class="config-section">
            <h2 data-i18n="server_instances">Server Instances (-s)</h2>
            <p class="section-desc" data-i18n="server_desc">Server Mode: OpenWrt listens for connections from remote clients.</p>
            <p class="traffic-flow" data-i18n="server_traffic_flow">Traffic Flow: Internet → WAN Port → [Decrypted] → Forward To IP:Port.</p>
            
            <div class="sub-tabs">
                <button class="sub-tab active" data-tab="server-config" onclick="switchSubTab('server','config')" data-i18n="config">Config</button>
                <button class="sub-tab" data-tab="server-status" onclick="switchSubTab('server','status')" data-i18n="status">Status</button>
            </div>
            
            <div id="server-config-content">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th data-i18n="name">Name</th>
                            <th data-i18n="enable">Enable</th>
                            <th data-i18n="wan_listen_port">WAN Listen Port</th>
                            <th data-i18n="forward_to_ip">Forward To IP</th>
                            <th data-i18n="forward_to_port">Forward To Port</th>
                            <th data-i18n="actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="server-table-body">
                        <tr class="empty-row"><td colspan="6" data-i18n="no_server_instances">No server instances configured.</td></tr>
                    </tbody>
                </table>
                <button class="btn btn-primary" onclick="openAddModal('server')" data-i18n="add_server">+ Add Server</button>
            </div>
            
            <div id="server-status-content" style="display:none">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th data-i18n="name">Name</th>
                            <th data-i18n="status">Status</th>
                            <th data-i18n="local">Local</th>
                            <th data-i18n="forward">Forward</th>
                            <th data-i18n="protocol">Protocol</th>
                            <th data-i18n="pid">PID</th>
                        </tr>
                    </thead>
                    <tbody id="server-status-table-body">
                        <tr class="empty-row"><td colspan="6" data-i18n="no_server_instances">No server instances.</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Client Instances -->
        <section class="config-section">
            <h2 data-i18n="client_instances">Client Instances (-c)</h2>
            <p class="section-desc" data-i18n="client_desc">Client Mode: OpenWrt connects to remote udp2raw server (VPS).</p>
            <p class="traffic-flow" data-i18n="client_traffic_flow">Traffic Flow: App → Local Port → [Encrypted] → Forward To VPS IP:Port.</p>
            
            <div class="sub-tabs">
                <button class="sub-tab active" data-tab="client-config" onclick="switchSubTab('client','config')" data-i18n="config">Config</button>
                <button class="sub-tab" data-tab="client-status" onclick="switchSubTab('client','status')" data-i18n="status">Status</button>
            </div>
            
            <div id="client-config-content">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th data-i18n="name">Name</th>
                            <th data-i18n="enable">Enable</th>
                            <th data-i18n="vps_address">VPS Address</th>
                            <th data-i18n="vps_port">VPS Port</th>
                            <th data-i18n="local_listen_port">Local Listen Port</th>
                            <th data-i18n="actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="client-table-body">
                        <tr class="empty-row"><td colspan="6" data-i18n="no_client_instances">No client instances configured.</td></tr>
                    </tbody>
                </table>
                <button class="btn btn-primary" onclick="openAddModal('client')" data-i18n="add_client">+ Add Client</button>
            </div>
            
            <div id="client-status-content" style="display:none">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th data-i18n="name">Name</th>
                            <th data-i18n="status">Status</th>
                            <th data-i18n="local">Local</th>
                            <th data-i18n="remote">Remote</th>
                            <th data-i18n="protocol">Protocol</th>
                            <th data-i18n="pid">PID</th>
                        </tr>
                    </thead>
                    <tbody id="client-status-table-body">
                        <tr class="empty-row"><td colspan="6" data-i18n="no_client_instances">No client instances.</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="saveConfig()" data-i18n="save_apply">Save & Apply</button>
            <button class="btn btn-outline" onclick="saveConfigOnly()" data-i18n="save_only">Save Only</button>
            <button class="btn btn-outline" onclick="resetConfig()" data-i18n="reset">Reset</button>
        </div>
    </main>

    <!-- Modal: Tunnel Configuration -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title" data-i18n="tunnel_config">UDP Tunnel Configuration</h3>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="basic" onclick="switchModalTab('basic')" data-i18n="basic_settings">Basic Settings</button>
                <button class="modal-tab" data-tab="advanced" onclick="switchModalTab('advanced')" data-i18n="advanced_settings">Advanced Settings</button>
            </div>
            <div class="modal-body">
                <!-- Basic Settings -->
                <div id="modal-basic">
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" class="checkbox" id="modal-enabled" checked>
                            <span data-i18n="enable">Enable</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="alias">Alias</label>
                        <input type="text" class="form-input" id="modal-alias">
                    </div>
                    
                    <!-- Server Fields -->
                    <div id="server-fields">
                        <div class="form-group">
                            <label class="form-label" data-i18n="wan_listen_port">WAN Listen Port</label>
                            <input type="number" class="form-input" id="modal-listen-port" value="29900">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="forward_to_ip">Forward To IP</label>
                            <input type="text" class="form-input" id="modal-forward-ip" value="127.0.0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="forward_to_port">Forward To Port</label>
                            <input type="number" class="form-input" id="modal-forward-port" value="51820">
                        </div>
                    </div>
                    
                    <!-- Client Fields -->
                    <div id="client-fields" style="display:none">
                        <div class="form-group">
                            <label class="form-label" data-i18n="vps_address">VPS Address</label>
                            <input type="text" class="form-input" id="modal-server-ip">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="vps_port">VPS Port</label>
                            <input type="number" class="form-input" id="modal-server-port" value="29900">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="local_listen_port">Local Listen Port</label>
                            <input type="number" class="form-input" id="modal-local-port" value="3333">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-i18n="password">Password (-k)</label>
                        <input type="password" class="form-input" id="modal-password" placeholder="*">
                        <span class="hint" data-i18n-title="password_hint">ⓘ</span>
                    </div>
                </div>
                
                <!-- Advanced Settings -->
                <div id="modal-advanced" style="display:none">
                    <!-- Server Advanced -->
                    <div id="server-fields-advanced">
                        <div class="form-group">
                            <label class="form-label" data-i18n="wan_listen_address">WAN Listen Address (-l)</label>
                            <input type="text" class="form-input" id="modal-listen-ip" value="0.0.0.0">
                            <span class="hint" data-i18n-title="wan_listen_address_hint">ⓘ</span>
                        </div>
                    </div>
                    
                    <!-- Client Advanced -->
                    <div id="client-advanced-fields" style="display:none">
                        <div class="form-group">
                            <label class="form-label" data-i18n="local_listen_address">Local Listen Address (-l)</label>
                            <input type="text" class="form-input" id="modal-local-ip" value="127.0.0.1">
                            <span class="hint" data-i18n-title="local_listen_address_hint">ⓘ</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-i18n="raw_mode">Raw Mode</label>
                        <select id="modal-raw-mode" class="form-select">
                            <option value="faketcp" data-i18n="faketcp">FakeTCP (Recommended)</option>
                            <option value="udp" data-i18n="udp">UDP</option>
                            <option value="icmp" data-i18n="icmp">ICMP</option>
                        </select>
                        <span class="hint" data-i18n-title="raw_mode_hint">ⓘ</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-i18n="cipher_mode">Cipher Mode</label>
                        <select id="modal-cipher-mode" class="form-select">
                            <option value="xor" data-i18n="xor_fast">XOR (Fast)</option>
                            <option value="aes128cbc" data-i18n="aes128cbc">AES-128-CBC</option>
                            <option value="none" data-i18n="cipher_none">None</option>
                        </select>
                        <span class="hint" data-i18n-title="cipher_mode_hint">ⓘ</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-i18n="auth_mode">Auth Mode</label>
                        <select id="modal-auth-mode" class="form-select">
                            <option value="simple" data-i18n="simple_basic">Simple (Basic)</option>
                            <option value="md5" data-i18n="md5">MD5</option>
                            <option value="crc32" data-i18n="crc32">CRC32</option>
                            <option value="hmac_sha1" data-i18n="hmac_sha1">HMAC-SHA1</option>
                        </select>
                        <span class="hint" data-i18n-title="auth_mode_hint">ⓘ</span>
                    </div>
                    
                    <!-- Client-only fields -->
                    <div id="client-advanced-fields-extra" style="display:none">
                        <div class="form-group">
                            <label class="form-label" data-i18n="source_ip">Source IP (--source-ip)</label>
                            <input type="text" class="form-input" id="modal-source-ip">
                            <span class="hint" data-i18n-title="source_ip_hint">ⓘ</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="source_port">Source Port (--source-port)</label>
                            <input type="text" class="form-input" id="modal-source-port">
                            <span class="hint" data-i18n-title="source_port_hint">ⓘ</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" class="checkbox" id="modal-auto-iptables" checked>
                            <span data-i18n="auto_iptables">Auto Add Iptables Rule (-a)</span>
                        </label>
                        <span class="hint" data-i18n-title="auto_iptables_hint">ⓘ</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-i18n="seq_mode">Sequence Mode</label>
                        <select id="modal-seq-mode" class="form-select">
                            <option value="0" data-i18n="seq_mode_0">0 - Disabled</option>
                            <option value="1" data-i18n="seq_mode_1">1 - Simple</option>
                            <option value="2" data-i18n="seq_mode_2">2 - Basic</option>
                            <option value="3" selected data-i18n="seq_mode_3">3 - Simulate real TCP (Recommended)</option>
                            <option value="4" data-i18n="seq_mode_4">4 - Full simulation</option>
                        </select>
                        <span class="hint" data-i18n-title="seq_mode_hint">ⓘ</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-i18n="extra_args">Extra Arguments</label>
                        <input type="text" class="form-input" id="modal-extra-args" placeholder="+">
                        <span class="hint" data-i18n-title="extra_args_hint">ⓘ</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()" data-i18n="close">Close</button>
                <button class="btn btn-primary" onclick="saveModal()" data-i18n="save">Save</button>
            </div>
        </div>
    </div>

    <!-- Modal: Diagnostics -->
    <div class="modal-overlay" id="diag-overlay">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 data-i18n="tunnel_status">UDP Tunnel Status</h3>
                <button class="modal-close" onclick="closeDiagnostics()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="diag-section">
                    <div class="diag-row">
                        <span class="diag-label" data-i18n="service_status">Service Status</span>:
                        <span id="diag-service-status"><span class="status-text stopped" data-i18n="stopped">Stopped</span></span>
                    </div>
                </div>
                
                <div class="diag-section">
                    <h4 data-i18n="tunnel_status">Tunnel Status</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-i18n="name">Name</th>
                                <th data-i18n="mode">Mode</th>
                                <th data-i18n="status">Status</th>
                                <th data-i18n="local">Local</th>
                                <th data-i18n="remote">Remote</th>
                                <th data-i18n="protocol">Protocol</th>
                                <th data-i18n="pid">PID</th>
                            </tr>
                        </thead>
                        <tbody id="diag-tunnel-table">
                            <tr class="empty-row"><td colspan="7" data-i18n="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="diag-section">
                    <h4 data-i18n="system_diagnostics">System Diagnostics</h4>
                    <div class="diag-row">
                        <span class="diag-label" data-i18n="core_binary">Core Binary</span>:
                        <span id="diag-binary">⏳ <span data-i18n="checking">Checking...</span></span>
                    </div>
                    <div class="diag-row">
                        <span class="diag-label" data-i18n="iptables_rules">Iptables Rules</span>:
                        <span id="diag-iptables">⏳ <span data-i18n="checking">Checking...</span></span>
                    </div>
                </div>
                
                <div class="diag-section">
                    <h4 data-i18n="recent_logs">Recent Logs</h4>
                    <p class="log-time" id="diag-log-time"><span data-i18n="last_updated">Last updated</span>: --</p>
                    <div class="log-container" id="log-container">
                        <pre id="log-content" data-i18n="loading_logs">Loading logs...</pre>
                    </div>
                    <div class="log-actions">
                        <button class="btn btn-outline btn-sm" onclick="refreshLogs()" data-i18n="refresh_logs">Refresh Logs</button>
                        <button class="btn btn-outline btn-sm" onclick="scrollLogsToBottom()" data-i18n="scroll_bottom">Scroll to Bottom</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
</body>
</html>
